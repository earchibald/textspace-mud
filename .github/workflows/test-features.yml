name: Comprehensive CI/CD Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -r requirements-db.txt
    
    - name: Run comprehensive test suite
      run: |
        python test_v1_2_0.py
    
    - name: Test server startup
      run: |
        timeout 10s python server.py &
        sleep 5
        pkill -f server.py || true
    
    - name: Validate configuration files
      run: |
        python -c "import yaml; yaml.safe_load(open('rooms.yaml'))"
        python -c "import yaml; yaml.safe_load(open('bots.yaml'))"
        python -c "import yaml; yaml.safe_load(open('items.yaml'))"
        python -c "import yaml; yaml.safe_load(open('scripts.yaml'))"

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -r requirements-db.txt
        pip install python-socketio[client]
    
    - name: Run integration test suite
      run: |
        python test_suite.py
      continue-on-error: true
    
    - name: Test live deployment
      run: |
        curl -f https://exciting-liberation-production.up.railway.app || echo "Live system check failed"
      continue-on-error: true

  deploy-notification:
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Notify deployment status
      run: |
        echo "âœ… Unit tests passed - core functionality verified"
        echo "ðŸš€ Railway auto-deployment triggered"
        echo "ðŸ“Š Integration tests completed (may have warnings)"
